<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
    <style>
    
    @font-face {
        font-family: 'AppleII';
        src: url('../Fonts/AppleII.ttf')  format('truetype'); /* Safari, Android, iOS */
    }

    </style>
    <script src="helperFunction/pipes.js"></script>
    <script src="helperFunction/console.js"></script>

		<script>

//------------------------------------=======############==========----------------------------------------
//                                 Hexagon tile generator
//------------------------------------=======############==========----------------------------------------

// https://www.redblobgames.com/grids/hexagons/

var ctx;
var mx,my;

var bitrep=[
      {tile:0 ,bits:[0,0,0,0,0,0]},
      {tile:1 ,bits:[1,1,1,1,1,1]},
      {tile:2 ,bits:[0,0,0,0,0,1]},
      {tile:3 ,bits:[0,0,0,0,1,0]},
      {tile:4 ,bits:[0,0,0,1,0,0]},
      {tile:5 ,bits:[0,0,1,0,0,0]},
      {tile:6 ,bits:[0,1,0,0,0,0]},
      {tile:7 ,bits:[1,0,0,0,0,0]},
      {tile:8 ,bits:[0,0,0,0,1,1]},
      {tile:9 ,bits:[0,0,0,1,1,0]},
      {tile:10,bits:[0,0,1,1,0,0]},
      {tile:11,bits:[0,1,1,0,0,0]},
      {tile:12,bits:[1,1,0,0,0,0]},
      {tile:13,bits:[1,0,0,0,0,1]},
      {tile:14,bits:[0,0,0,1,1,1]},
      {tile:15,bits:[0,0,1,1,1,0]},
      {tile:16,bits:[0,1,1,1,0,0]},
      {tile:17,bits:[1,1,1,0,0,0]},
      {tile:18,bits:[1,1,0,0,0,1]},
      {tile:19,bits:[1,0,0,0,1,1]},
      {tile:20,bits:[0,0,1,1,1,1]},
      {tile:21,bits:[0,1,1,1,1,0]},
      {tile:22,bits:[1,1,1,1,0,0]},
      {tile:23,bits:[1,1,1,0,0,1]},
      {tile:24,bits:[1,1,0,0,1,1]},
      {tile:25,bits:[1,0,0,1,1,1]},
      {tile:26,bits:[0,1,1,1,1,1]},
      {tile:27,bits:[1,1,1,1,1,0]},
      {tile:28,bits:[1,1,1,1,0,1]},
      {tile:29,bits:[1,1,1,0,1,1]},
      {tile:30,bits:[1,1,0,1,1,1]},
      {tile:31,bits:[1,0,1,1,1,1]}
];

// Across indices for each side point e.g. 2 is across from 0 and 3 is across from 5 
var indices=[
    [0,2,5,3],
    [1,3,0,4],
    [1,5,2,4],
    [2,0,3,5],
    [3,1,4,0],
    [4,2,5,1]
];

var tileoffs=[
    {x:0,y:-1},
    {x:-1,y:-1},
    {x:-1,y:0},
    {x:0,y:1},
    {x:1,y:0},
    {x:1,y:-1}
];

//----------------------------------------------------------------------------------
// Canvas Setup
//----------------------------------------------------------------------------------

function setup()
{
    consloe=new Conio(40,8,"console");

    mainctx = document.getElementById("myCanvas").getContext("2d");
    ctx=mainctx;

    computeallowed();

    drawit();
}

// nlist[0]={tile:0,weight:0.95,nolist:[{x:1,y:0,items:[2,3,4,5,6,8,9]},{x:-1,y:0,items:[2,3,4,5,7,10,11]},{x:0,y:1,items:[1,3,4,6,7,9,11]},{x:0,y:-1,items:[1,3,5,6,7,8,10]}]};

function computeallowed()
{
    // For each tile
    var tilelist=[];
    for (var tileno=0;tileno<bitrep.length;tileno++){
        var tile={};
        tile.no=tileno;
        tile.weight=0.99;
        tile.nolist=[];
        // For each side in each tile
        for(var side=0;side<6;side++){
            var sideobj={x:tileoffs[side].x,y:tileoffs[side].y,items:[]};
            // Iterate over all tiles
            var item=indices[side];
            var lst=[];
            for(var innertile=0;innertile<bitrep.length;innertile++){
                // Accumulate allowed list for tile side
                if((bitrep[tileno].bits[item[0]]==bitrep[innertile].bits[item[1]])&&(bitrep[tileno].bits[item[2]]==bitrep[innertile].bits[item[3]])){
                    lst.push(innertile);
                }
            }
            // Move only disallowed pieces to nolist
            for(var allow=0;allow<bitrep.length;allow++){
                if(lst.indexOf(allow)==-1) sideobj.items.push(allow);
            }
            tile.nolist.push(sideobj)
        }
        tilelist.push(tile);
    }
//    console.log(tilelist);
}

//--------------------------------------------------------------------------
// update
// ---------------
//  Updates one tile at tx,ty and changes the entropy of surrounding tiles
//  Also adds surrounding tiles to queue
//--------------------------------------------------------------------------

var svgstr="";
var generatesvg=true;
function drawit()
{	
    ctx=mainctx;

    if(generatesvg){
        svgstr="<?xml version='1.0' encoding='utf-8'?>";
        svgstr+="<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 1920 1080' xml:space='preserve'>\n";

        svgstr+="<g id='ocean'>\n";
        svgstr+="    <polygon fill='#29ABE2' points='57,0 19,0 0,33 19,66 57,66 76,33 57,0";
        svgstr+="</g>\n"
    }

    ctx.clearRect(0,0,900,900);
    ctx.fillStyle="#888";
    ctx.strokeStyle="#000";

    var xk=0;
    var yk=0;
    for(var i=0;i<40;i++){
        ctx.save();
        ctx.translate(xk,yk);
        genTile(i);
        ctx.restore();
        yk+=66;
        if(yk>(66*12)){
            yk=0;
            xk+=76;
        }        
    }

    if(generatesvg){
        svgstr+="</svg>";
        document.body.innerHTML="<textarea>"+svgstr+"</textarea>";
    }

/*
    ctx.save();
    ctx.translate(200,200);
    ctx.scale(2.0,2.0);
    genTile(5);
    ctx.restore();
*/

    //window.requestAnimationFrame(drawit);
}

// Polygon drawing that also generates SVG polygon

function drawPoints(color,pointlist)
{
    if(pointlist.length==0) return;
    if(generatesvg) svgstr+="    <polygon fill='"+color+"' points='";
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.moveTo(pointlist[0].x,pointlist[0].y);
    for(var i=1;i<pointlist.length;i++){
        ctx.lineTo(pointlist[i].x,pointlist[i].y);
    }
    if(generatesvg){
        for(var i=0;i<pointlist.length;i++){
            svgstr+=(Math.floor(pointlist[i].x*10.0)/10.0)+","+(Math.floor(pointlist[i].y*10.0)/10.0)+" ";
        }
    }
    ctx.lineTo(pointlist[0].x,pointlist[0].y);
    ctx.fill();
    if(generatesvg) svgstr+="' />\n";
}

function drawCirc(color,p)
{
    ctx.beginPath();
    ctx.fillStyle=color;
    ctx.arc(p.x, p.y, 1.5, 0, 2 * Math.PI);
    ctx.fill();
}

function midpoint(p1,p2,kind)
{
    return {x:((p1.x+p2.x)*0.5),y:((p1.y+p2.y)*0.5),kind:kind};
}

function displace(p1,p2,jitter,kind)
{
    // Random displacement based on jitter value
    var magnitude=(Math.random()*jitter)-(jitter*0.5);

    // Compute normal of line segment
    var dx=p1.y-p2.y;
    var dy=-(p1.x-p2.x);
    var len=Math.sqrt((dx*dx)+(dy*dy));
    dx=(dx/len)*magnitude;
    dy=(dy/len)*magnitude;

    var mpx=((p1.x+p2.x)*0.5);
    var mpy=((p1.y+p2.y)*0.5);  
               
    return {
        x:mpx+dx,
        y:mpy+dy,
        kind:1
      }
}

//--------------------------------------------------------------------------
// smooth
// ---------------
//  We add jittered point between existing points that are not locked on
//  either end of line
//--------------------------------------------------------------------------

function smooth(pointarr,jitter)
{
  var newarr=[];
  if(pointarr==null) return newarr;
  for(var i=0;i<pointarr.length;i++){
      var curr=pointarr[i];
      var next=pointarr[(i+1)%pointarr.length];
      newarr.push(curr);
      if(curr.kind>0&&next.kind>0) newarr.push(displace(curr,next,jitter,1));
  }
  return newarr;
}

function drawLine(x1,y1,x2,y2)
{
      ctx.strokeStyle="#036";
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
}

function intersect(x1, y1, x2, y2, x3, y3, x4, y4, kind) {

  // Check if none of the lines are of length 0
	if ((x1 === x2 && y1 === y2) || (x3 === x4 && y3 === y4)) {
		return false
	}

	denominator = ((y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1))

  // Lines are parallel
	if (denominator === 0) {
		return false
	}

	let ua = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denominator
	let ub = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / denominator

  // Return a object with the x and y coordinates of the intersection
	let x = x1 + ua * (x2 - x1)
	let y = y1 + ua * (y2 - y1)

	return {x:x, y:y, kind:kind}
}

//--------------------------------------------------------------------------
// offset
// ---------------
//  We move the movable points along the added vector direction. Reqires
//  Normalized vector (after adding?) to account for magnitude
//--------------------------------------------------------------------------

function offset(pointarr,magnitude)
{
    var newpointarr=[];
    for(var i=0;i<pointarr.length;i++){
        var curr=pointarr[i];
        var next=pointarr[(i+1)%pointarr.length];
        if(i==0){
            var prev=pointarr[pointarr.length-1];
        }else{
            var prev=pointarr[i-1];
        }
        if(curr.kind==1){
            var dx=curr.y-next.y;
            var dy=-(curr.x-next.x);
            var len=Math.sqrt((dx*dx)+(dy*dy));
            dx=(dx/len)*magnitude;
            dy=(dy/len)*magnitude;

            var ex=prev.y-curr.y;
            var ey=-(prev.x-curr.x);
            var len=Math.sqrt((ex*ex)+(ey*ey));
            ex=(ex/len)*magnitude;
            ey=(ey/len)*magnitude;

            var p1=
            newpointarr.push(intersect(curr.x+dx,curr.y+dy,next.x+dx,next.y+dy,curr.x+ex,curr.y+ey,prev.x+ex,prev.y+ey,1));
        }else if(curr.kind==2){

            if(next.kind==0){
                var dy=next.y-curr.y;
                var dx=next.x-curr.x;
                var len=Math.sqrt((dx*dx)+(dy*dy));
                dx=(dx/len)*magnitude;
                dy=(dy/len)*magnitude;
                newpointarr.push({x:curr.x+dx,y:curr.y+dy,kind:2});            
            }else if(prev.kind==0){
                var dy=prev.y-curr.y;
                var dx=prev.x-curr.x;
                var len=Math.sqrt((dx*dx)+(dy*dy));
                dx=(dx/len)*magnitude;
                dy=(dy/len)*magnitude;
                newpointarr.push({x:curr.x+dx,y:curr.y+dy,kind:2});               
            }
        }else if(curr.kind==0){
                newpointarr.push({x:curr.x,y:curr.y,kind:0});                      
        }
    }  
    return newpointarr;  
}

function normalize(p1,p2)
{
    var dx=p2.x-p1.x;
    var dy=p2.y-p1.y;

    var len=Math.sqrt((dx*dx)+(dy*dy));
    dx/=len;
    dy/=len;

    return {x:dx,y:dy};
}

function displacerand(p1,jitter,kind)
{
    // Random displacement based on jitter value
    var magnitudex=(Math.random()*jitter)-(jitter*0.5);
    var magnitudey=(Math.random()*jitter)-(jitter*0.5);

    return {x:p1.x+magnitudex,y:p1.y+magnitudey,kind:kind};
}

function genTile(tileno)
{
    var jitter=22;

    var p1={x:57,y:0,kind:0};
    var p2={x:19,y:0,kind:0};
    var p3={x:0,y:33,kind:0};
    var p4={x:19,y:66,kind:0};
    var p5={x:57,y:66,kind:0};
    var p6={x:76,y:33,kind:0};

    var p0=displacerand({x:38,y:33},jitter,1);

    var h1=midpoint(p1,p2,2);
    var h2=midpoint(p2,p3,2);
    var h3=midpoint(p3,p4,2);
    var h4=midpoint(p4,p5,2);
    var h5=midpoint(p5,p6,2);
    var h6=midpoint(p6,p1,2);

    if(generatesvg) svgstr+="<g id='tile"+tileno+"'>\n";

    var arr=[p1,p2,p3,p4,p5,p6];

    if(!generatesvg) drawPoints("#29ABE2",arr);
    
    var arra;
    if(tileno==0){
        arra=[p1,p2,p3,p4,p5,p6];
    }else if(tileno==1){
        arra=[p1,p2,p3,p4,p5,p6];
    }else if(tileno==2){
        arra=[h1,p1,h6,p0];
    }else if(tileno==3){
        arra=[h6,p6,h5,p0];
    }else if(tileno==4){
        arra=[h5,p5,h4,p0];    
    }else if(tileno==5){
        arra=[h4,p4,h3,p0];
    }else if(tileno==6){
        arra=[h3,p3,h2,p0];
    }else if(tileno==7){
        arra=[h2,p2,h1,p0];
    }else if(tileno==8){
        arra=[h1,p1,p6,h5,p0];    
    }else if(tileno==9){
        arra=[h6,p6,p5,h4,p0];    
    }else if(tileno==10){
        arra=[h5,p5,p4,h3,p0];     
    }else if(tileno==11){
        arra=[h4,p4,p3,h2,p0];      
    }else if(tileno==12){
        arra=[h3,p3,p2,h1,p0];    
    }else if(tileno==13){
        arra=[h2,p2,p1,h6,p0];    
    }else if(tileno==14){
        arra=[h1,p1,p6,p5,h4,p0];
    }else if(tileno==15){
        arra=[h6,p6,p5,p4,h3,p0];
    }else if(tileno==16){
        arra=[h5,p5,p4,p3,h2,p0];    
    }else if(tileno==17){
        arra=[h4,p4,p3,p2,h1,p0];    
    }else if(tileno==18){
        arra=[h3,p3,p2,p1,h6,p0];    
    }else if(tileno==19){
        arra=[h2,p2,p1,p6,h5,p0];    
    }else if(tileno==20){
        arra=[h1,p1,p6,p5,p4,h3,p0];
    }else if(tileno==21){
       arra=[h6,p6,p5,p4,p3,h2,p0];
    }else if(tileno==22){
      arra=[h5,p5,p4,p3,p2,h1,p0];
    }else if(tileno==23){
      arra=[h4,p4,p3,p2,p1,h6,p0];    
    }else if(tileno==24){
      arra=[h3,p3,p2,p1,p6,h5,p0];
    }else if(tileno==25){
      arra=[h2,p2,p1,p6,p5,h4,p0];
    }else if(tileno==26){
      arra=[h1,p1,p6,p5,p4,p3,h2,p0];    
    }else if(tileno==27){
      arra=[h6,p6,p5,p4,p3,p2,h1,p0]   
    }else if(tileno==28){
      arra=[h5,p5,p4,p3,p2,p1,h6,p0];   
    }else if(tileno==29){
      arra=[h4,p4,p3,p2,p1,p6,h5,p0];   
    }else if(tileno==30){
      arra=[h3,p3,p2,p1,p6,p5,h4,p0]; 
    }else if(tileno==31){
      arra=[h2,p2,p1,p6,p5,p4,h3,p0];
    }

    if(tileno>1&&tileno<=40){
        arra=smooth(arra,jitter*0.4);
        arra=smooth(arra,jitter*0.3);
    }

    if(tileno>=1){
        drawPoints("#A67C52",arra);            
    }

    if(tileno>=1){
        var arro=offset(arra,5);
        drawPoints("#C69C6D",arro);            
    }

    ctx.beginPath();
    ctx.fillStyle="Black";
    ctx.textBaseline="top";
    ctx.font="14px AppleII";
    ctx.fillText(tileno,2,2);
    ctx.fill();

    svgstr+="</g>\n"
  
}

function clickCanvas(e)
{
    var tx=Math.floor(mx/bw);
    var ty=Math.floor(my/bw);
    
    if(e.button==0){
        blockTemplate[ty][tx]=tileno;    
    }else if(e.button=2){
        blockTemplate[ty][tx]=0;        
    }

    consloe.log(tx+" "+ty+" "+e.button);    
    
    return false;
}

function mouseMove(e){
    var rect = e.target.getBoundingClientRect();
    mx = e.clientX - rect.left; //x position within the element.
    my = e.clientY - rect.top;  //y position within the element. 
    targetid=e.target.id;       
}

		</script>
</head>
<body onload="setup();">
 	<canvas id="myCanvas" width="900" height="900" style="border:1px solid #000000;" onmousemove="mouseMove(event)" onclick="clickCanvas(event)" oncontextmenu="clickCanvas(event); event.preventDefault();" ></canvas>
 	<canvas id="toolCanvas" width="64" height="900" style="border:1px solid #8000f0;" onmousemove="mouseMove(event)" onclick="clickTools(event)" oncontextmenu="clickTools(event); event.preventDefault();"></canvas>
  <div id="console" style="font-family:AppleII;border:1px solid #381;width:964px;height:200px;white-space:pre;"></div>
</body>
