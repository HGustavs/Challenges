<!DOCTYPE html>
<html>
<head>
    <script>document.write("<script type='text/javascript' src='helperFunction/hexcolors.js?t=" + Date.now() + "'><\/script>");</script>
    <script>document.write("<script type='text/javascript' src='helperFunction/spatialHash.js?t=" + Date.now() + "'><\/script>");</script>
    <script>document.write("<script type='text/javascript' src='helperFunction/canvasDraw.js?t=" + Date.now() + "'><\/script>");</script>

		<script>
var c;
var mx,my,mb=0;
var testcnt=0;

// Input data set from https://digg.com/puzzmo/link/flipart

var variants=[
    // We do right-most and top-most as start
    
    // 2-Capsule 2 variants 
    {offs:[{x:0,y:0},{x:-1,y:0}]},
    {offs:[{x:0,y:0},{x:0,y:1}]},

    // 3-L 4 variants
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1}]},   
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:0}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:1}]},
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1}]},

    // 3-Capsule S 2 Variants
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-2,y:0}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:0,y:2}]},

    // 4-L 4 variants
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-2,y:0},{x:-2,y:1}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:2}]},
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:-1,y:-2}]},
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-2,y:0},{x:-2,y:-1}]},

    // 4-B 1 Variant
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1}]},

    // 4-T 4 Variants
    {offs:[{x:0,y:0},{x:-1,y:-1},{x:-1,y:0},{x:-2,y:0}]},
    {offs:[{x:0,y:0},{x:-1,y:-1},{x:-1,y:0},{x:-1,y:1}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:1},{x:0,y:2}]},
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:-2,y:0}]},

    // 5-U 4 Variants
    {offs:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:-1,y:0},{x:-1,y:2}]},
    {offs:[{x:0,y:0},{x:0,y:-2},{x:-1,y:0},{x:-1,y:-1},{x:-1,y:-2}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:1},{x:-2,y:0},{x:-2,y:1}]},
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-2,y:0},{x:-2,y:1}]},

    // 5-B 4 Variants
    {offs:[{x:0,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:1},{x:-2,y:0}]},
    {offs:[{x:0,y:0},{x:-1,y:0},{x:-1,y:1},{x:-2,y:0},{x:-2,y:1}]}

];

// Playfield dimensions
var playfield=[];
var tilelist=[];
const border=2;
const tileW=8;
const tileH=8;
const tileRow=tileW+border+border;

const tilecolors=["#fbd","#fdb","#bfd","#dfb","#bdf","#dbf"];

// Returns tile count at position x,y. Returns -1 if outside playfield area including border
function readPlayfield(x,y)
{
    if(x>=(tileW+border)||y>=(tileH+border)||x<border||y<border) return -1;

    return playfield[(y*tileRow)+x].length;
}

// Pushes value to playfield. Respects outer border.
function pushPlayfield(x,y,param)
{
    if(x>(tileW+border+border)||x>(tileH+border+border)||x<0||y<0) return false;

    playfield[(y*tileRow)+x].push(param);
}

// Pops value from playfield. Respects outer border.
function popPlayfield(x,y,param)
{
   if(x>(tileW+border+border)||x>(tileH+border+border)||x<0||y<0) return false;
   if(playfield[(y*tileRow)+x].length==0) return false;

   return playfield[(y*tileRow)+x].pop();
}

function zetup()
{
	  var cc = document.getElementById("myCanvas");
    c = cc.getContext("2d");

    // Make/Clear playfield
    for(let j=0;j<(tileH+border+border);j++){
        for(let i=0;i<(tileW+border+border);i++){
            playfield[(j*tileRow)+i]=[];    
        }
    }

    // Colorize tiles
    var no=0;
    for(variant of variants){
        variant.col=tilecolors[Math.floor(Math.random()*tilecolors.length)];
        variant.no=no++;
    }

    updatestate();
}

function drawTile(x,y,fillstate,color)
{
    c.beginPath();
    c.moveTo(x*20,y*20);
    c.lineTo((x+1)*20,y*20);
    c.lineTo((x+1)*20,(y+1)*20);
    c.lineTo(x*20,(y+1)*20);
    c.lineTo(x*20,y*20);
    if(fillstate){
        c.fillStyle=color;
        c.fill();
    }else{
        c.stroke();
    }
}

function updatestate()
{
    // Go over all tiles
    for(let i=(tileW+border-1);i>=border;i--){
        for(let j=border;j<(tileH+border);j++){
            var current=readPlayfield(i,j);

            // If current cell is 0 we test for possible candidates much like wave function collapse
            if(current==0){
                let candidates=[];
                for(candidate of variants){
                    let status=true;
                    for(offs of candidate.offs){
                        if(readPlayfield(i+offs.x,j+offs.y)!=0) status=false;
                    }
                    if(status) candidates.push(candidate.no);
                }
                if(candidates.length>0){
                    let pieceno=candidates[Math.floor(Math.random()*candidates.length)];
                    let piece=variants[pieceno];
                    for(offs of piece.offs){
                        pushPlayfield(i+offs.x,j+offs.y,piece.no);
                    }

                    // Save tile to tile list
                    tilelist.push({x:i,y:j,rot:0,variant:piece});                 
                }
            }
        }
    }

    // Draw playfield
    for(let i=(tileW+border-1);i>=border;i--){
        for(let j=border;j<(tileH+border);j++){        
            drawTile(i,j,false);
        }
    }

    // Draw tiles
    for(tile of tilelist){
        for(offs of tile.variant.offs){
            drawTile(tile.x+offs.x,tile.y+offs.y,true,tile.variant.col);
        }        
    }
}		
			
		</script>
</head>
<body onload="zetup();">
 	<canvas id="myCanvas" width="900" height="900" style="border:1px solid #000000;"></canvas> 
  <button onclick="generate();">Render</button>
</body>