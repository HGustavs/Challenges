<html>
<head>
		<script>
				var c;
			  var mx,my,mb=0;
				
        var circles=[];
        var lines=[];

        var vx=0.5;
        var vy=-2;

				var curr=-1;

        var friction=0.90;
        var gravity=0.5;
			
				function setup()
				{
						var cc = document.getElementById("myCanvas");
				    c = cc.getContext("2d");

            //circles.push({x:70,y:100,r:30,vx:0.5,vy:1,streak:[]});
            //circles.push({x:120,y:110,r:40,vx:-0.5,vy:1.2,streak:[]});
            //circles.push({x:90,y:80,r:30,vx:0.8,vy:1.5,streak:[]});

            circles.push({x:70,y:100,r:30,vx:0.5,vy:0,streak:[]});
            circles.push({x:120,y:110,r:40,vx:-0.5,vy:0,streak:[]});
            circles.push({x:90,y:80,r:30,vx:0.8,vy:0,streak:[]});

            lines.push({x1:20,y1:140,x2:300,y2:220});
            lines.push({x1:400,y1:300,x2:210,y2:370});
            lines.push({x1:20,y1:400,x2:300,y2:520});

						setInterval(updatestate,20);
					
						drawit();
				}
								
				function updatestate()
				{
            // Update fall parabola
            for(var i=0;i<circles.length;i++){
                var circle=circles[i];
                //circle.y+=3;

                circle.vy+=gravity;

                circle.x+=circle.vx;
                circle.y+=circle.vy;

                circle.streak.push({x:circle.x,y:circle.y})
            }            

            // Move circles to avoid stationary objects
            for(var i=0;i<lines.length;i++){
                var line=lines[i];
                for(var j=0;j<circles.length;j++){
                    var circle=circles[j];
                    var pnt=project(line.x1,line.y1,line.x2,line.y2,circle.x,circle.y);
                    if(pnt.l<(circle.r*circle.r)){
                        var len=Math.sqrt(pnt.l);
                        var part=(circle.r-len)/len;
                        var dx=(pnt.x-circle.x)*part;
                        var dy=(pnt.y-circle.y)*part;
                        circle.x-=dx;
                        circle.y-=dy;
                        
                        var v=reflect(line.x1,line.y1,line.x2,line.y2,circle.vx,circle.vy);
                        circle.vx=v.x*friction;
                        circle.vy=v.y*friction;
                    }
                }
            }

            // Compare circles to circles and push away according to center
            for(var i=0;i<circles.length;i++){
                for(var j=0;j<circles.length;j++){
                    if(j!=i){
                        var c1=circles[i];
                        var c2=circles[j];
                        var tot=c1.r+c2.r;
                        dx=c2.x-c1.x;
                        dy=c2.y-c1.y;
                        // This sqrt can be avoided
                        len=Math.sqrt((dx*dx)+(dy*dy));
                        if(len<tot){
                            var ox=dx*((len-c1.r-c2.r)/len/2);
                            var oy=dy*((len-c1.r-c2.r)/len/2);
                            c1.x+=ox;
                            c1.y+=oy;
                            c2.x-=ox;
                            c2.y-=oy;
                        }
                    }
                } 
            }
				}
			
				function mouseUp(e)
				{
						mb=0;
				}
			
				function mouseDown(e)
				{
						mb=e.which;
				}
			
				function mouseMove(e,t)
				{
						var rect = e.target.getBoundingClientRect();
            mx = e.clientX - rect.left; //x position within the element.
            my = e.clientY - rect.top;  //y position within the element
				}

        function makeNormal(x1,y1,x2,y2)
        {
            var dx=x2-x1;
            var dy=y2-y1;
            var len=Math.sqrt((dx*dx)+(dy*dy));
            
            return {x:dy/len,y:-dx/len};
        }

        // Reflect dx vector using line segment
        // Line normal can be precomputed
        // https://math.stackexchange.com/questions/13261/how-to-get-a-reflection-vector
        function reflect(x1,y1,x2,y2,vx,vy)
        {
            var n=makeNormal(x1,y1,x2,y2)
            var d=(vx*n.x)+(vy*n.y);

            return {x:vx-(2.0*d*n.x),y:vy-(2.0*d*n.y)};
        }

        //----------------------------------------------------------------------------------
        // inseg - Uses projection to find the point along a segment that is closest to a line
        //----------------------------------------------------------------------------------        
        // Returns closest point along a line and squared length of line
        // https://stackoverflow.com/questions/849211/shortest-distance-between-a-point-and-a-line-segment
        // https://jsfiddle.net/soulwire/UA6H5/

        function project( ax,ay,bx,by,px,py ) {
            var dx=bx-ax;
            var dy=by-ay;
            var pdx=px-ax;
            var pdy=py-ay;
            var len=(dx*dx)+(dy*dy);
            var dot=(pdx*dx)+(pdy*dy);
            var t = Math.min( 1, Math.max( 0, dot / len ) );
            dot = (bx-ax)*(py-ay)-(by-ay)*(px-ax);
            var xk=ax+dx*t;
            var yk=ay+dy*t;
            dx=xk-px;
            dy=yk-py;
            return {x:xk,y:yk,l:((dx*dx)+(dy*dy))}
    }

        function drawCirc(x,y,r,fill)
        {
            c.beginPath();
            c.arc(x, y, r, 0, 2 * 3.1415, false);
            if(fill==true){
                c.fill();	
            }else{
                c.stroke();	
            }
        }

        function drawLine(x1,y1,x2,y2)
        {
            c.beginPath();
            c.moveTo(x1,y1);
            c.lineTo(x2,y2);
            c.stroke();
        }
			
				function drawit()
				{	
						c.clearRect(0,0,900,900);
					
						c.font="20px Arial Narrow";
						// c.fillText("Mb:"+dx+" "+dy+" "+ang,100,50);

            c.strokeStyle="#6aa";
            for(var i=0;i<lines.length;i++){
                var line=lines[i];
                drawLine(line.x1,line.y1,line.x2,line.y2);
            }

            c.strokeStyle="#a6a";
            for(var i=0;i<circles.length;i++){
                var circ=circles[i];
                drawCirc(circ.x,circ.y,circ.r);
            }

            c.strokeStyle="#d72";
            for(var i=0;i<circles.length;i++){
                var circ=circles[i];
                c.beginPath();
                
                for(var j=0;j<circ.streak.length;j++){
                      var st=circ.streak[j];
                      if(j==0){
                          c.moveTo(st.x,st.y);
                      }
                      c.lineTo(st.x,st.y);
                }
                c.stroke();
            }


            window.requestAnimationFrame(drawit);
				} 			

		</script>
</head>
<body onload="setup();">
 	<canvas id="myCanvas" onmousedown="mouseDown(event);" onmouseup="mouseUp(event);" onmousemove="mouseMove(event,this);" width="900" height="900" style="border:1px solid #000000;"></canvas> 
</body>
